<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trial Tribal Dataset v1.5</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Trial Tribal Dataset</h1>
    </header>

    <section class="card">
      <div class="filters">
        <label>
          <span>CARE</span>
          <select id="care">
            <option value="">All</option>
            <option value="C">C — Collective Benefit</option>
            <option value="A">A — Authority to Control</option>
            <option value="R">R — Responsibility</option>
            <option value="E">E — Ethics</option>
          </select>
        </label>

        <label>
          <span>UNDRIP</span>
          <select id="undrip">
            <option value="">All</option>
            <option value="I">I — Internal Autonomy</option>
            <option value="C">C — Collective Authority</option>
            <option value="E">E — External Participation</option>
          </select>
        </label>

        <label>
          <span>Tribe</span>
          <select id="tribe">
            <option value="">All (with YES)</option>
          </select>
        </label>

        <label class="full">
          <span>Keyword</span>
          <input id="search" type="text" placeholder="Search across columns… (section, subsection, question, #)" />
        </label>

        <button id="apply">Apply</button>
      </div>

      <div class="controls">
        <span class="right" id="count"></span>
      </div>
    </section>

    <section class="card row">
      <table>
        <thead>
          <tr>
            <th style="width:6%">#</th>
            <th style="width:24%">Section / Subsection</th>
            <th style="width:44%">Question</th>
            <th style="width:10%">CARE</th>
            <th style="width:10%">UNDRIP</th>
            <th style="width:7%">Yes</th>
            <th style="width:8%">Tribes / Justifications</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </div>

  <script>
    const SUPABASE_URL = "https://hkqhdfpafsclurftgjdo.supabase.co";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrcWhkZnBhZnNjbHVyZnRnamRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjkxNjYsImV4cCI6MjA3Njc0NTE2Nn0.9K-IAMcDEDDuS7ok1ZsXEa2AbaA7TT7_nCGUf8CpF08";

    function api(path, params = {}) {
      const url = new URL(`${SUPABASE_URL}${path}`);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      return fetch(url.toString(), {
        headers: {
          apikey: ANON_KEY,
          Authorization: `Bearer ${ANON_KEY}`,
          Prefer: "count=exact",
          Range: "0-999"
        }
      });
    }

    function option(el, value, text) {
      const o = document.createElement('option');
      o.value = value;
      o.textContent = text ?? value;
      el.appendChild(o);
    }

    function includesToken(value, token) {
      if (!token) return true;
      if (!value) return false;
      const set = value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      return set.includes(token.toUpperCase());
    }

    async function loadTribesWithYes() {
      const res = await api('/rest/v1/questions_long', {
        select: 'tribe_code',
        distinct: 'true',
        answer: 'eq.true'
      });
      const data = await res.json();
      const tribeSelect = document.getElementById('tribe');
      tribeSelect.innerHTML = '<option value="">All (with YES)</option>';
      const seen = new Set();
      const tribeMap = { tribe_a: "A", tribe_b: "B", tribe_c: "C", tribe_d: "D", tribe_e: "E" };
      for (const r of data) {
        const val = r.tribe_code?.trim();
        if (!val || seen.has(val)) continue;
        seen.add(val);
        const label = tribeMap[val.toLowerCase()] || val;
        option(tribeSelect, val, label);
      }
    }

    async function fetchQuestions() {
      const care = document.getElementById('care').value;
      const undrip = document.getElementById('undrip').value;
      const tribe = document.getElementById('tribe').value;
      const q = document.getElementById('search').value.trim();

      const params = {
        select: 'question_number,section,subsection,question_text,care_principal,undrip,answer,tribe_code,final_justification',
        order: 'question_number.asc'
      };

      // ✅ Only apply filters if something is selected
      if (care || undrip || tribe || q) {
        const ors = [];
        if (q) {
          const cleaned = q.replace(/[%*]/g, '').trim();
          const term = `*${cleaned}*`;
          ors.push(
            `question_text.ilike.${term}`,
            `section.ilike.${term}`,
            `subsection.ilike.${term}`,
            `care_principal.ilike.${term}`,
            `undrip.ilike.${term}`,
            `tribe_code.ilike.${term}`
          );
          if (/^\d+$/.test(cleaned)) ors.push(`question_number.eq.${cleaned}`);
          params.or = `(${ors.join(",")})`;
        }
      }

      const res = await api('/rest/v1/questions_long', params);
      const data = await res.json();

      const byQ = new Map();
      for (const r of data) {
        if (!includesToken(r.care_principal, care)) continue;
        if (!includesToken(r.undrip, undrip)) continue;
        if (tribe && r.tribe_code !== tribe) continue;

        const key = r.question_number;
        if (!byQ.has(key)) {
          byQ.set(key, {
            question_number: r.question_number,
            section: r.section,
            subsection: r.subsection,
            question_text: r.question_text,
            care_principal: r.care_principal,
            undrip: r.undrip,
            yes: 0,
            total: 0,
            yesTribes: [],
            justifications: []
          });
        }

        if (r.answer === true) {
          const entry = byQ.get(key);
          entry.yes++;
          entry.total++;
          if (r.tribe_code) {
            entry.yesTribes.push(r.tribe_code);
            if (r.final_justification) {
              entry.justifications.push({
                tribe_code: r.tribe_code,
                text: r.final_justification
              });
            }
          }
        } else if (r.answer === false) {
          byQ.get(key).total++;
        }
      }

      const rowsAgg = Array.from(byQ.values()).sort((a,b) => a.question_number - b.question_number);
      document.getElementById('count').textContent = `${rowsAgg.length} question(s) loaded`;
      renderRowsAggregated(rowsAgg);
    }

    function renderRowsAggregated(rows) {
      const tbody = document.getElementById('rows');
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan='7'>No results</td></tr>";
        return;
      }

      const careMap = { C: "Collective Benefit", A: "Authority to Control", R: "Responsibility", E: "Ethics" };
      const undripMap = { I: "Internal Autonomy", C: "Collective Authority", E: "External Participation" };
      const tribeMap = { tribe_a: "A", tribe_b: "B", tribe_c: "C", tribe_d: "D", tribe_e: "E" };

      tbody.innerHTML = rows.map(r => {
        const careExpanded = r.care_principal
          ? r.care_principal.split(',').map(c => `<span class="label care">${careMap[c.trim()] || c}</span>`).join(' ')
          : '<span class="meta">—</span>';

        const undripExpanded = r.undrip
          ? r.undrip.split(',').map(u => `<span class="label undrip">${undripMap[u.trim()] || u}</span>`).join(' ')
          : '<span class="meta">—</span>';

        const percent = r.total > 0 ? ((r.yes / r.total) * 100).toFixed(1) : 0;

        const tribes = r.yesTribes?.length
          ? Array.from(new Set(r.yesTribes))
              .map(t => `<span class="tag">${tribeMap[t.toLowerCase()] || t}</span>`)
              .join(' ')
          : '<span class="meta">—</span>';

        const justifications = r.justifications.length
          ? `
            <div class="just-list">
              ${r.justifications.map(j => `
                <div class="just-item">
                  <div class="just-tribe">${tribeMap[j.tribe_code] || j.tribe_code}</div>
                  <div class="just-text">${j.text}</div>
                </div>
              `).join('')}
            </div>
          `
          : '<span class="meta">No justifications yet.</span>';

        return `
          <tr>
            <td>${r.question_number}</td>
            <td>
              <div><strong>${r.section || ''}</strong></div>
              <div class="meta">${r.subsection || ''}</div>
            </td>
            <td>${r.question_text}</td>
            <td class="care-cell"><div class="labels">${careExpanded}</div></td>
            <td class="undrip-cell"><div class="labels">${undripExpanded}</div></td>
            <td class="yes-cell">
              <div class="yes-fraction">${r.yes} / ${r.total || 0}</div>
              <div class="yes-percent meta">${percent}%</div>
            </td>
            <td>
              ${tribes}
              <details class="just-details">
                <summary>View ${r.justifications.length || 'No'} Justification${r.justifications.length !== 1 ? 's' : ''}</summary>
                ${justifications}
              </details>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('apply').addEventListener('click', fetchQuestions);
    document.getElementById('care').addEventListener('change', fetchQuestions);
    document.getElementById('undrip').addEventListener('change', fetchQuestions);
    document.getElementById('tribe').addEventListener('change', fetchQuestions);
    document.getElementById('search').addEventListener('keydown', e => { if (e.key === 'Enter') fetchQuestions(); });

    (async function init(){
      await loadTribesWithYes();
      await fetchQuestions(); // ✅ auto-load all data on open
    })();
  </script>
</body>
</html>
