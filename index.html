<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trial Tribal Dataset v1.4</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Trial Tribal Dataset</h1>
    </header>

    <!-- =========================
         Filter Controls
         ========================= -->
    <section class="card">
      <div class="filters">
        <label>
          <span>CARE</span>
          <select id="care">
            <option value="">All</option>
            <option value="C">C — Collective Benefit</option>
            <option value="A">A — Authority to Control</option>
            <option value="R">R — Responsibility</option>
            <option value="E">E — Ethics</option>
          </select>
        </label>

        <label>
          <span>UNDRIP</span>
          <select id="undrip">
            <option value="">All</option>
            <option value="I">I — Internal Autonomy</option>
            <option value="C">C — Collective Authority</option>
            <option value="E">E — External Participation</option>
          </select>
        </label>

        <label>
          <span>Tribe</span>
          <select id="tribe">
            <option value="">All (with YES)</option>
          </select>
        </label>

        <label class="full">
          <span>Keyword</span>
          <input id="search" type="text" placeholder="Search across columns… (section, subsection, question, #)" />
        </label>

        <button id="apply">Apply</button>
      </div>

      <div class="controls">
        <span class="right" id="count"></span>
      </div>
    </section>

    <!-- =========================
         Table Output
         ========================= -->
    <section class="card row">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Section / Subsection</th>
            <th>Question</th>
            <th>CARE</th>
            <th>UNDRIP</th>
            <th>Yes</th>
            <th>Tribes / Justifications</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </div>

  <!-- =========================
       Script
       ========================= -->
  <script>
    const SUPABASE_URL = "https://hkqhdfpafsclurftgjdo.supabase.co";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrcWhkZnBhZnNjbHVyZnRnamRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjkxNjYsImV4cCI6MjA3Njc0NTE2Nn0.9K-IAMcDEDDuS7ok1ZsXEa2AbaA7TT7_nCGUf8CpF08";

    // ---------- Helpers ----------
    function api(path, params = {}) {
      const url = new URL(`${SUPABASE_URL}${path}`);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      return fetch(url.toString(), {
        headers: {
          apikey: ANON_KEY,
          Authorization: `Bearer ${ANON_KEY}`,
          Prefer: "count=exact",
          Range: "0-999"
        }
      });
    }

    function option(el, value, text) {
      const o = document.createElement('option');
      o.value = value;
      o.textContent = text ?? value;
      el.appendChild(o);
    }

    function includesToken(value, token) {
      if (!token) return true;
      if (!value) return false;
      const set = value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      return set.includes(token.toUpperCase());
    }

    // ---------- Load Tribes ----------
    async function loadTribesWithYes() {
      const res = await api('/rest/v1/questions_long', {
        select: 'tribe_code',
        distinct: 'true',
        answer: 'eq.true'
      });
      if (!res.ok) {
        console.error('loadTribesWithYes error:', await res.text());
        return;
      }

      const data = await res.json();
      const tribeSelect = document.getElementById('tribe');
      tribeSelect.innerHTML = '<option value="">All (with YES)</option>';
      const seen = new Set();

      const tribeMap = {
        tribe_a: "A",
        tribe_b: "B",
        tribe_c: "C",
        tribe_d: "D",
        tribe_e: "E"
      };

      for (const r of data) {
        const val = r.tribe_code?.trim();
        if (!val || seen.has(val)) continue;
        seen.add(val);
        const label = tribeMap[val.toLowerCase()] || val;
        option(tribeSelect, val, label);
      }
    }

    // ---------- Fetch + Aggregate ----------
    async function fetchQuestions() {
      const tbody = document.getElementById('rows');
      tbody.innerHTML = "<tr><td colspan='7'><span class='meta'>Loading data…</span></td></tr>";

      const care = document.getElementById('care').value;
      const undrip = document.getElementById('undrip').value;
      const tribe = document.getElementById('tribe').value;
      const q = document.getElementById('search').value.trim();

      const params = {
        select: 'question_number,section,subsection,question_text,care_principal,undrip,answer,tribe_code,final_justification',
        ord
